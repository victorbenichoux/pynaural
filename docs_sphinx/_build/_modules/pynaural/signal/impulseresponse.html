<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pynaural.signal.impulseresponse &mdash; Pynaural 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Pynaural 0.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
        <div class="headertitle"><a
          href="../../../index.html">Pynaural 0.1 documentation</a></div>
        <div class="rel">
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pynaural.signal.impulseresponse</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="kn">as</span> <span class="nn">cmap</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">numpy.fft</span> <span class="kn">import</span> <span class="n">fft</span><span class="p">,</span> <span class="n">fftfreq</span><span class="p">,</span> <span class="n">ifft</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">decimate</span>
<span class="kn">from</span> <span class="nn">pynaural.signal.misc</span> <span class="kn">import</span> <span class="n">dB_SPL</span><span class="p">,</span> <span class="n">fftconvolve</span><span class="p">,</span> <span class="n">dBconv</span>
<span class="kn">from</span> <span class="nn">pynaural.signal.smoothing</span> <span class="kn">import</span> <span class="n">apply_windowing</span><span class="p">,</span> <span class="n">nonuniform_spectralsmoothing</span><span class="p">,</span> <span class="n">octaveband_smoothing</span>
<span class="kn">from</span> <span class="nn">pynaural.utils.spatprefs</span> <span class="kn">import</span> <span class="n">get_pref</span>
<span class="kn">from</span> <span class="nn">pynaural.utils.debugtools</span> <span class="kn">import</span> <span class="n">log_debug</span>
<span class="kn">from</span> <span class="nn">pynaural.signal.sounds</span> <span class="kn">import</span> <span class="n">Sound</span><span class="p">,</span> <span class="n">pinknoise</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ImpulseResponse&#39;</span><span class="p">,</span> <span class="s">&#39;TransferFunction&#39;</span><span class="p">,</span>
           <span class="s">&#39;onesIR&#39;</span><span class="p">,</span> <span class="s">&#39;zerosIR&#39;</span><span class="p">,</span> <span class="s">&#39;delayIR&#39;</span><span class="p">,</span> <span class="s">&#39;binauralIR&#39;</span><span class="p">,</span>
           <span class="s">&#39;dur2sample&#39;</span><span class="p">,</span> <span class="s">&#39;sample2dur&#39;</span><span class="p">,</span> <span class="s">&#39;TransferFunction&#39;</span><span class="p">,</span>
           <span class="s">&#39;onesTF&#39;</span><span class="p">,</span> <span class="s">&#39;zerosTF&#39;</span><span class="p">,</span> <span class="s">&#39;delayTF&#39;</span><span class="p">,</span> <span class="s">&#39;binauralTF&#39;</span><span class="p">]</span>

<span class="c">#####################################################################################################</span>
<span class="c">########################################## Impulse Response #########################################</span>
<span class="c">#####################################################################################################</span>
        
<div class="viewcode-block" id="ImpulseResponse"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse">[docs]</a><span class="k">class</span> <span class="nc">ImpulseResponse</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    :class:`ImpulseResponse` for working with impulses responses. </span>
<span class="sd">    This class basically behaves like an numpy.ndarray with each channel arranged as a column.</span>
<span class="sd">    </span>
<span class="sd">    Useful features:</span>
<span class="sd">    </span>
<span class="sd">    ... listening</span>
<span class="sd">    ir.listen()</span>
<span class="sd">    ... Spat related stuff</span>
<span class="sd">    ir.forsource(i)</span>
<span class="sd">    ir.nsources</span>
<span class="sd">    ...coordinates related stuff</span>
<span class="sd">    ir.forcoordinate</span>
<span class="sd">    ir.ncoordinates</span>
<span class="sd">    ir.coordinates</span>
<span class="sd">    .... dsp stuff</span>
<span class="sd">    ir.apply</span>
<span class="sd">    ... plotting</span>
<span class="sd">    ir.plot</span>

<span class="sd">    ir.reorder_coordinates</span>

<span class="sd">    Is used in the binaural cues module to compute itds/ilds</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> 
                <span class="n">samplerate</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="c"># major attributes</span>
                <span class="n">binaural</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="c"># binaural flag</span>
                <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="c"># coordinates attributes</span>
                <span class="n">target_source</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="c"># spatializer related</span>
                <span class="n">is_delay</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="p">):</span>
        <span class="c"># Possibly initialize with TransferFunction</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">TransferFunction</span><span class="p">):</span>
            <span class="c"># that is for sure</span>
            <span class="n">data_ift</span> <span class="o">=</span> <span class="n">ifft</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
            <span class="c"># then add all relevant attributes</span>
            <span class="n">kwdargs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data_ift</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">samplerate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">samplerate</span> <span class="o">=</span> <span class="n">get_pref</span><span class="p">(</span><span class="s">&#39;DEFAULT_SAMPLERATE&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mf">44100.</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">cls</span><span class="p">,</span> <span class="n">data</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Wrong Impulse Response initialization&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_source</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">target_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">target_source</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="c"># minimum attributes</span>
        <span class="n">x</span><span class="o">.</span><span class="n">samplerate</span> <span class="o">=</span> <span class="n">samplerate</span>
        <span class="c"># flags for different types of IR</span>
        <span class="n">x</span><span class="o">.</span><span class="n">binaural</span> <span class="o">=</span> <span class="n">binaural</span>
        <span class="n">x</span><span class="o">.</span><span class="n">is_delay</span> <span class="o">=</span> <span class="n">is_delay</span>

        <span class="n">x</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">_makecoordinates</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">binaural</span> <span class="o">=</span> <span class="n">binaural</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">target_source</span> <span class="o">=</span> <span class="n">_make_target_source</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">target_source</span><span class="p">,</span> <span class="n">binaural</span> <span class="o">=</span> <span class="n">binaural</span><span class="p">)</span>
         
        <span class="c"># buffering</span>
        <span class="n">x</span><span class="o">.</span><span class="n">buffer_init</span><span class="p">()</span><span class="c">#not sure about that</span>
        <span class="k">return</span> <span class="n">x</span>
    
    <span class="c">################## internals</span>
    <span class="c"># util for new object/view creation</span>
    <span class="c"># pass whenever creating a new ImpulseResponse in this class</span>
    <span class="k">def</span> <span class="nf">get_kwdargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_slice</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c"># major attribute</span>
            <span class="s">&#39;samplerate&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">,</span>
            <span class="c"># binaural flag</span>
            <span class="s">&#39;binaural&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">,</span>
            <span class="c"># coordinates attributes</span>
            <span class="s">&#39;coordinates&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">,</span>
            <span class="c"># spatializer related            </span>
            <span class="s">&#39;target_source&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_source</span><span class="p">,</span>
            <span class="c"># to simplify apply</span>
            <span class="s">&#39;is_delay&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_delay</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># kwdargs slicing</span>
            <span class="c"># binaural: the ir stays binaural iff all the channels are taken</span>
            <span class="k">if</span> <span class="n">_slice</span>  <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">_slice</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">test</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                    <span class="n">res</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># coordinates</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_coordinates</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">_slice</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="c"># spatializer internals</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_sources</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s">&#39;target_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_source</span><span class="p">[</span><span class="n">_slice</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="c">################### ndarray internals</span>
    <span class="k">def</span> <span class="nf">__array_wrap__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">handled</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">__array_wrap__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#39;samplerate&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;samplerate&#39;</span><span class="p">):</span>
            <span class="n">x</span><span class="o">.</span><span class="n">samplerate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ufunc</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="c"># major attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;samplerate&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c"># binaural flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;binaural&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="c"># coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;coordinates&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c"># spatializer internals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_source</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;target_source&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        
    <span class="c">################## Buffering</span>
    <span class="c"># TODO: - CHECK BUFFERABLE (like Sounds)</span>
    <span class="c"># - what do with channels?</span>
    <span class="k">def</span> <span class="nf">buffer_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
        
    <span class="k">def</span> <span class="nf">buffer_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">start</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;Can only use positive indices in buffer.&#39;</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">samples</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">samples</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span>
        <span class="k">return</span> <span class="n">X</span>
    
    <span class="c">################## SLICING #######################</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        
<div class="viewcode-block" id="ImpulseResponse.trim"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.trim">[docs]</a>    <span class="k">def</span> <span class="nf">trim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the same HRIR but trimmed between start and stop. If start or stop are floats, they are interpreted as times.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">dur2sample</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">dur2sample</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>                
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="ImpulseResponse.zeropad"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.zeropad">[docs]</a>    <span class="k">def</span> <span class="nf">zeropad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nzeros</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Adds the specified number of zeros at the end of the IR</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nzeros</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="n">zero</span><span class="p">))</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ImpulseResponse.ramp"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.ramp">[docs]</a>    <span class="k">def</span> <span class="nf">ramp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">where</span> <span class="o">=</span> <span class="s">&#39;both&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Adds the specified number of zeros at the end of the IR</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">envelope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">where</span> <span class="o">==</span> <span class="s">&#39;in&#39;</span><span class="p">:</span>
            <span class="n">envelope</span><span class="p">[:</span><span class="n">nsamples</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">)))</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">elif</span> <span class="n">where</span> <span class="o">==</span> <span class="s">&#39;out&#39;</span><span class="p">:</span>
            <span class="n">envelope</span><span class="p">[</span><span class="o">-</span><span class="n">nsamples</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">)))</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">envelope</span><span class="p">[:</span><span class="n">nsamples</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">)))</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">envelope</span><span class="p">[</span><span class="o">-</span><span class="n">nsamples</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">)))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="o">*</span><span class="n">envelope</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">subsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">factor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">ksig</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">data</span><span class="p">[:,</span><span class="n">ksig</span><span class="p">]</span> <span class="o">=</span> <span class="n">decimate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">)[:,</span><span class="n">ksig</span><span class="p">],</span> <span class="n">factor</span><span class="p">)</span>

        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">()</span>
        <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;samplerate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;samplerate&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">factor</span>
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        
    <span class="c">################## binaural stuff</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">(</span><span class="n">_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:])</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">(</span><span class="n">_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

<span class="c">################## Coordinates</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_has_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncoordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_coordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Impulse Response doesnt have coordinates&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ImpulseResponse.forcoordinates"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.forcoordinates">[docs]</a>    <span class="k">def</span> <span class="nf">forcoordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Should return an impulseResponse containing all the rays headed towards source args</span>
<span class="sd">        </span>
<span class="sd">        Usage:</span>
<span class="sd">        hrir.forcoordinates(20, 0) # returns az = 20 and elev =0</span>
<span class="sd">        hrir.forcoordinates([20, 0], [0, 5]) interpreted as az in [20,0] and elev in [0,5] so 4 pairs</span>
<span class="sd">        hrir.forcoordinates(lambda azim,elev: azim == 0 and elev in [0,7.5]</span>
<span class="sd">        </span>
<span class="sd">        hrir.forcoordinates(i) to iterate over positions</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># argument parsing</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c"># indexing is just the i&#39;th IR</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c"># kwdargs handling</span>
            <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">(</span><span class="n">_slice</span> <span class="o">=</span> <span class="n">i</span><span class="p">)</span>
        
            <span class="c"># data collection</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">idx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">fun</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">):</span>
                    <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="p">[:,</span> <span class="n">idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span><span class="mi">2</span><span class="p">]))</span>

            
                <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">(</span><span class="n">_slice</span> <span class="o">=</span> <span class="n">idx</span><span class="p">)</span>
                <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_debug</span><span class="p">(</span><span class="s">&#39;No HRTF found matching condition&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>
            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">azs</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">els</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">azs</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
                <span class="n">azs</span> <span class="o">=</span> <span class="p">[</span><span class="n">azs</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">els</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
                <span class="n">els</span> <span class="o">=</span> <span class="p">[</span><span class="n">els</span><span class="p">]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">azim</span><span class="p">,</span> <span class="n">elev</span><span class="p">:</span> <span class="n">azim</span> <span class="ow">in</span> <span class="n">azs</span> <span class="ow">and</span> <span class="n">elev</span> <span class="ow">in</span> <span class="n">els</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcoordinates</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    
    <span class="c">#################### Spatializer features</span>
    <span class="c"># this includes:</span>
    <span class="c"># attrs:</span>
    <span class="c"># - incoming_direction,source</span>
    <span class="c"># methods:</span>
    <span class="c"># - forsource()</span>
    <span class="c"># flags for different types of ImpulseResponse</span>
    </div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_has_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_source</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nsources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_sources</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_source</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<div class="viewcode-block" id="ImpulseResponse.forsource"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.forsource">[docs]</a>    <span class="k">def</span> <span class="nf">forsource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the part of the impulse response that is related to source k (as precised in the target_source attribute)</span>
<span class="sd">        Only implemented for impulse response that are the result of computations in the spatializer</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;This method isnt implemented for this type of IR&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_source</span> <span class="o">!=</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No data for this source&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_source</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">(</span><span class="n">_slice</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="c">#                 kwdargs[&#39;binaural&#39;] = self.binaural</span>
                <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
            </div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_source</span><span class="p">)</span>

    <span class="c">################### DSP Features</span>
    <span class="c"># -listening of IRs</span>
    <span class="c"># -applying to sounds</span>
    <span class="k">def</span> <span class="nf">rms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)))</span>

<div class="viewcode-block" id="ImpulseResponse.downsample"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.downsample">[docs]</a>    <span class="k">def</span> <span class="nf">downsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Downsamples the ImpulseResponse by a factor q (integer). Makes use of scipy.signal.decimate.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:,:]</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">()</span>
        <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;samplerate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;samplerate&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">q</span>
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
    </div>
    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">/</span><span class="n">value</span><span class="o">*</span><span class="n">level</span>

<div class="viewcode-block" id="ImpulseResponse.atlevel"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.atlevel">[docs]</a>    <span class="k">def</span> <span class="nf">atlevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Normalizes the IR relative to its most intensive source (in terms of max)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        
        </div>
<div class="viewcode-block" id="ImpulseResponse.listen"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.listen">[docs]</a>    <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sound</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">sleep</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">reference</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If impulse response is more than one binaural or monaural,</span>
<span class="sd">        then all the sounds are played in a sequence</span>
<span class="sd">        </span>
<span class="sd">        TDO: WRITE DOC</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">sound</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">soundfile</span> <span class="o">=</span> <span class="n">get_pref</span><span class="p">(</span><span class="s">&#39;DEFAULT_SOUND&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">soundfile</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">os</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">soundfile</span><span class="p">):</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">soundfile</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&#39;wav&#39;</span><span class="p">]</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">))]</span>
                    <span class="n">soundfile</span> <span class="o">+=</span> <span class="n">f</span>
                <span class="n">sound</span> <span class="o">=</span> <span class="n">Sound</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">soundfile</span><span class="p">)</span><span class="o">.</span><span class="n">left</span>
            <span class="k">if</span> <span class="n">soundfile</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">sound</span><span class="o">.</span><span class="n">samplerate</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">:</span>
                <span class="n">sound</span> <span class="o">=</span> <span class="n">pinknoise</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">samplerate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">sound</span> <span class="o">=</span> <span class="n">Sound</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reference</span><span class="p">:</span>
            <span class="n">log_debug</span><span class="p">(</span><span class="s">&#39;Listening to original sound&#39;</span><span class="p">)</span>
            <span class="n">sound</span><span class="o">.</span><span class="n">atlevel</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">sleep</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_coordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
                <span class="n">log_debug</span><span class="p">(</span><span class="s">&#39;Listening to IR for coordinates &#39;</span><span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_debug</span><span class="p">(</span><span class="s">&#39;Listening to IR for coordinates &#39;</span><span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_debug</span><span class="p">(</span><span class="s">&#39;Listening to IR&#39;</span><span class="p">)</span>
            
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Sound</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">atlevel</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">sleep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
        
</div>
<div class="viewcode-block" id="ImpulseResponse.apply"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">outlevel</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Applies the current Impulse responses to a sound.</span>
<span class="sd">        Either yields a single sound in the case where the Impulse response is only relative to a single source. Otherwise outputs a list of sounds for each source.</span>
<span class="sd">        </span>
<span class="sd">        Gain normalisation (outlevel kwdarg): </span>
<span class="sd">        By default no gain, otherwise the gain is adjusted to that the loudest channel is at the level specified by outlevel. Hence the difference in level between the two channels is preserved. This is a different behavior from the one in brian.hears.sounds        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Sound</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ImpulseResponse</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">samplerate</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">log_debug</span><span class="p">(</span><span class="s">&#39;Warning, samplerates not matching!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Samplerates not matching&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_coordinates</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncoordinates</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsources</span><span class="p">):</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcoordinates</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">outlevel</span> <span class="o">=</span> <span class="n">outlevel</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">outlevel</span> <span class="o">=</span> <span class="n">outlevel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Can only apply to a sound or IR&#39;</span><span class="p">)</span>
            </div>
    <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">outlevel</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_delay</span><span class="p">:</span>
                    <span class="n">delay_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">delay_samples</span><span class="p">:</span><span class="n">delay_samples</span><span class="o">+</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="p">[:,</span><span class="n">chan</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span><span class="p">[:,</span> <span class="n">chan</span><span class="p">]</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">other</span><span class="p">[:,</span><span class="n">chan</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Sound</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">samplerate</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">samplerate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">nchannels</span> <span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">log_debug</span><span class="p">(</span><span class="s">&#39;Applying IR separately to each channel&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_delay</span><span class="p">:</span>
                    <span class="n">delay_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">delay_samples</span><span class="p">:</span><span class="n">delay_samples</span><span class="o">+</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">delay_samples</span><span class="p">:</span><span class="n">delay_samples</span><span class="o">+</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="bp">self</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                    <span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="bp">self</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_delay</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;here&quot;</span>
                    <span class="n">delay_samples_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">delay_samples_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">delay_samples_0</span><span class="p">:</span><span class="n">delay_samples_0</span><span class="o">+</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">delay_samples_1</span><span class="p">:</span><span class="n">delay_samples_1</span><span class="o">+</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="bp">self</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                    <span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="bp">self</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">outlevel</span><span class="p">:</span>
                    <span class="n">rms_dB_left</span> <span class="o">=</span> <span class="n">dB_SPL</span><span class="p">(</span><span class="n">res</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">rms_dB_right</span> <span class="o">=</span> <span class="n">dB_SPL</span><span class="p">(</span><span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">gain_dB</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">outlevel</span><span class="o">-</span><span class="n">rms_dB_left</span><span class="p">,</span> <span class="n">outlevel</span><span class="o">-</span><span class="n">rms_dB_right</span><span class="p">)</span>
                    <span class="n">gain</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">gain_dB</span><span class="p">)</span><span class="o">/</span><span class="mf">20.</span><span class="p">)</span>
                    <span class="n">res</span> <span class="o">*=</span> <span class="n">gain</span>
            <span class="k">return</span> <span class="n">Sound</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">samplerate</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">samplerate</span><span class="p">)</span>

<div class="viewcode-block" id="ImpulseResponse.window"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.window">[docs]</a>    <span class="k">def</span> <span class="nf">window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">bandwidth</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Uses smoothing.apply_windowing to window the impulseresponse</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">apply_windowing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">,</span> <span class="n">bandwidth</span> <span class="o">=</span> <span class="n">bandwidth</span><span class="p">)</span>

<span class="c">######################### Plotting</span></div>
    <span class="k">def</span> <span class="nf">plot_binaural_cues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">selftf</span> <span class="o">=</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">selftf</span><span class="o">.</span><span class="n">plot_binaural_cues</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

<div class="viewcode-block" id="ImpulseResponse.plot"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutIR</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">display</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">dB</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        easy plotting of IRs</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># dB conversion?</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="n">suff</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">suff</span> <span class="o">+=</span> <span class="s">&#39; (dB)&#39;</span>
        
        <span class="c"># IR truncation?</span>
        <span class="n">cutIR</span> <span class="o">=</span> <span class="n">cutIR</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cutIR</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">cutIR</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">cutIR</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">)</span>

        <span class="n">cutIR</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">cutIR</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c"># plotting per se</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">/=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
                <span class="n">dataleft</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="bp">self</span><span class="p">[:</span><span class="n">cutIR</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
                <span class="n">dataright</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="bp">self</span><span class="p">[:</span><span class="n">cutIR</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">])</span>
                <span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
                <span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cutIR</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">),</span> <span class="n">dataleft</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">+</span><span class="s">&#39; L&#39;</span><span class="p">)</span>
                <span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
                <span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cutIR</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">),</span> <span class="n">dataright</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">+</span><span class="s">&#39; R&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cutIR</span><span class="p">)</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">),</span> <span class="bp">self</span><span class="p">[:</span><span class="n">cutIR</span><span class="p">,</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">)</span>

        <span class="c"># axes labeling, legends</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
            <span class="n">axleft</span> <span class="o">=</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
            <span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Left IR&#39;</span><span class="o">+</span><span class="n">suff</span><span class="p">)</span>
            <span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Time (ms)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">legend</span><span class="p">()</span>
            <span class="n">axright</span> <span class="o">=</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">legend</span><span class="p">()</span>
            <span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Right IR&#39;</span><span class="o">+</span><span class="n">suff</span><span class="p">)</span>
            <span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Time (ms)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">legend</span><span class="p">()</span>
            <span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;IR&#39;</span><span class="o">+</span><span class="n">suff</span><span class="p">)</span>
            <span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Time (ms)&#39;</span><span class="p">)</span>
        <span class="c"># display?</span>
        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">show</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ImpulseResponse.plot_spectrum"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.plot_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calls plot on the transfer function from this ir</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ImpulseResponse.convolve"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.convolve">[docs]</a>    <span class="k">def</span> <span class="nf">convolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        convolving two IRs should take them to the Frequency domain, linear convolve them</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Not yet&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Sound</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ImpulseResponse</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Can only convole sounds and impulse responses&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Shape mismatch in convolution&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">samplerate</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Samplerate mismatch&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">nchannels</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchannels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Number of channels mismatch&#39;</span><span class="p">)</span>

        <span class="n">self_offset0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">self_offset1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">other_offset0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">other_offset1</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">other</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c"># we do a real linear convolution, mostly because lengths never match</span>
        <span class="c"># it is costly so we try and trim the scene IRs that are quite often sparse</span>
        <span class="n">nself</span> <span class="o">=</span> <span class="n">self_offset1</span> <span class="o">-</span> <span class="n">self_offset0</span>
        <span class="n">nother</span> <span class="o">=</span> <span class="n">other_offset1</span> <span class="o">-</span> <span class="n">other_offset0</span>
        <span class="n">N</span> <span class="o">=</span>  <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">log2</span><span class="p">(</span><span class="n">nself</span> <span class="o">+</span> <span class="n">nother</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">self_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="p">[</span><span class="n">self_offset0</span><span class="p">:</span><span class="n">self_offset1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span> <span class="o">-</span> <span class="n">nself</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchannels</span><span class="p">))))</span>
        <span class="n">other_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">other</span><span class="p">[</span><span class="n">other_offset0</span><span class="p">:</span><span class="n">other_offset1</span><span class="p">,:],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span> <span class="o">-</span> <span class="n">nother</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">nchannels</span><span class="p">))))</span>
        <span class="n">convolution</span> <span class="o">=</span> <span class="n">ifft</span><span class="p">(</span><span class="n">fft</span><span class="p">(</span><span class="n">self_padded</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">fft</span><span class="p">(</span><span class="n">other_padded</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">((</span><span class="n">zeros</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">self_offset0</span> <span class="o">+</span> <span class="n">other_offset0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchannels</span><span class="p">)),</span> 
                      <span class="n">convolution</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">((</span><span class="n">res</span><span class="p">,</span> <span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchannels</span><span class="p">))))</span>
        
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">samplerate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">,</span> <span class="n">binaural</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">,</span> <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
            

    <span class="c"># ndarray stuff</span></div>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
    
<div class="viewcode-block" id="ImpulseResponse.reorder_coordinates"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.reorder_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">reorder_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a version of the ImpulseResponse with coordinates reordered according to the (ncoordinates,) integer permuation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">()</span>
        <span class="n">newcoordinates</span> <span class="o">=</span> <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">][:</span><span class="bp">self</span><span class="o">.</span><span class="n">ncoordinates</span><span class="p">][</span><span class="n">order</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">ncoordinates</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,</span><span class="n">order</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncoordinates</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,</span><span class="n">order</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ncoordinates</span><span class="p">]</span>
        <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcoordinates</span>
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="c">##### TODO : check why repr and str don&#39;t work without this</span></div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s">&quot;ImpulseResponse object</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="s">&quot;Samplerate: </span><span class="si">%.1f</span><span class="s"> Hz</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="s">&quot;Binaural: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">({</span><span class="bp">True</span><span class="p">:</span> <span class="s">&quot;yes&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">:</span> <span class="s">&quot;no&quot;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="s">&quot;Shape (Nsamples, Nchannels): (</span><span class="si">%d</span><span class="s">, </span><span class="si">%d</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_coordinates</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="s">&quot;coordinates:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__repr__</span><span class="p">())</span>

    <span class="c"># global properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nchannels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nsamples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span>

    <span class="c"># acoustics related measures</span>
<div class="viewcode-block" id="ImpulseResponse.responsetime"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.responsetime">[docs]</a>    <span class="k">def</span> <span class="nf">responsetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criterion</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the response time, that is the time when the initial signal loses 60 dB.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">criterion</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">criterion</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">cumenergy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">)</span>
        <span class="n">totalenergy</span> <span class="o">=</span>  <span class="n">cumenergy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">cumenergy</span><span class="o">/</span><span class="n">totalenergy</span> <span class="o">&gt;</span> <span class="n">criterion</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span>
        <span class="k">return</span> <span class="n">res</span>
</div>
    <span class="k">def</span> <span class="nf">reverberationtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">responsetime</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">itd_onset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">onset_time</span><span class="p">(</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">onset_time</span><span class="p">(</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">)</span>

<div class="viewcode-block" id="ImpulseResponse.onset_time"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.onset_time">[docs]</a>    <span class="k">def</span> <span class="nf">onset_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="o">.</span><span class="mi">15</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="s">&#39;time&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the time it takes for the IR to reach threshold of its max value</span>
<span class="sd">        `` unit&#39;&#39; if &#39;samples&#39;, then in samples, if &#39;time&#39; (default) then is second.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thresholds</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">thresholds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">)[:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s">&#39;samples&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ids</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ids</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span>
    

    <span class="c"># load/save</span></div>
<div class="viewcode-block" id="ImpulseResponse.save"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Saves the impulse response as a npz file on the file specified by fileobj.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">additional_info</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">])</span>
        
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span>
                 <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span>
                 <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">,</span>
                 <span class="n">target_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_source</span><span class="p">,</span>
                 <span class="n">additional_info</span> <span class="o">=</span> <span class="n">additional_info</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ImpulseResponse.load"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.ImpulseResponse.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">coordsfilter</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Loads an impulse response as saved using the .save method.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">npzfile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>

        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">npzfile</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">))</span> <span class="ow">and</span> <span class="n">coordsfilter</span><span class="p">:</span>
            <span class="n">azs</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="s">&#39;azim&#39;</span><span class="p">]</span>
            <span class="n">els</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="s">&#39;elev&#39;</span><span class="p">]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azs</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">azs</span><span class="p">)):</span>
                <span class="n">az</span> <span class="o">=</span> <span class="n">azs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">el</span> <span class="o">=</span> <span class="n">els</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">coordsfilter</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">):</span>
                    <span class="n">indices</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span><span class="c">#np.ones(npzfile[&#39;data&#39;].shape[1], dtype = bool)</span>

        <span class="n">target_source</span> <span class="o">=</span> <span class="n">npzfile</span><span class="p">[</span><span class="s">&#39;target_source&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">target_source</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">target_source</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">target_source</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">coordsfilter</span><span class="p">:</span>
            <span class="n">target_source</span> <span class="o">=</span> <span class="n">target_source</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">npzfile</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][:,</span> <span class="n">indices</span><span class="p">]</span>        
        <span class="n">additional_info</span> <span class="o">=</span> <span class="n">npzfile</span><span class="p">[</span><span class="s">&#39;additional_info&#39;</span><span class="p">]</span>
        <span class="n">samplerate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">additional_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">binaural</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">additional_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">res</span> <span class="o">=</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> 
                              <span class="n">coordinates</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">,</span> 
                              <span class="n">target_source</span> <span class="o">=</span> <span class="n">target_source</span><span class="p">,</span>
                              <span class="n">binaural</span> <span class="o">=</span> <span class="n">binaural</span><span class="p">,</span>
                              <span class="n">samplerate</span> <span class="o">=</span> <span class="n">samplerate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>        

    <span class="c"># constructors</span></div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">zerosIR</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">_shape_from_kwdargs</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">kwdargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">delayIR</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">defaultsamplerate</span> <span class="o">=</span> <span class="n">get_pref</span><span class="p">(</span><span class="s">&#39;DEFAULT_SAMPLERATE&#39;</span><span class="p">,</span>
                                            <span class="n">default</span> <span class="o">=</span> <span class="mf">44100.</span><span class="p">)</span>
        <span class="n">samplerate</span> <span class="o">=</span> <span class="n">kwdargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;samplerate&#39;</span><span class="p">,</span> <span class="n">defaultsamplerate</span><span class="p">)</span>

        <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;is_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">delay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">zerosIR</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delay</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">delay</span><span class="o">*</span><span class="n">samplerate</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Delay too long for the duration of the IR&#39;</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="n">delay</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">onesIR</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">_shape_from_kwdargs</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">kwdargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">binauralIR</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
    </div>
<span class="n">zerosIR</span> <span class="o">=</span> <span class="n">ImpulseResponse</span><span class="o">.</span><span class="n">zerosIR</span>        
<span class="n">onesIR</span> <span class="o">=</span> <span class="n">ImpulseResponse</span><span class="o">.</span><span class="n">onesIR</span>
<span class="n">delayIR</span> <span class="o">=</span> <span class="n">ImpulseResponse</span><span class="o">.</span><span class="n">delayIR</span>        
<span class="n">binauralIR</span> <span class="o">=</span> <span class="n">ImpulseResponse</span><span class="o">.</span><span class="n">binauralIR</span>        
        
<div class="viewcode-block" id="TransferFunction"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction">[docs]</a><span class="k">class</span> <span class="nc">TransferFunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    :class:`TransferFunction` for working with Transfer Function. It is the companion class of :class:`ImpulseResponse` in the frequency domain.</span>
<span class="sd">    </span>
<span class="sd">    Useful features:</span>
<span class="sd">    </span>
<span class="sd">    ... listening</span>
<span class="sd">    tf.listen()</span>
<span class="sd">    ... Spat related stuff</span>
<span class="sd">    tf.forsource(i)</span>
<span class="sd">    tf.nsources</span>
<span class="sd">    ...coordinates related stuff</span>
<span class="sd">    tf.forcoordinate</span>
<span class="sd">    tf.ncoordinates</span>
<span class="sd">    .... dsp stuff</span>
<span class="sd">    tf.apply</span>
<span class="sd">    ... plotting</span>
<span class="sd">    tf.plot_spectrum</span>
<span class="sd">    tf.plot</span>

<span class="sd">    Is used in the binaural cues module to compute itds/ilds</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> 
                <span class="n">nfft</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                <span class="n">samplerate</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="c"># major attributes</span>
                <span class="n">binaural</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="c"># binaural flag</span>
                <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="c"># coordinates attributes</span>
                <span class="n">target_source</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="c"># spatializer related</span>
                <span class="p">):</span>
        <span class="c"># Possibly initialize with TransferFunction</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ImpulseResponse</span><span class="p">):</span>
            <span class="c"># that is for sure</span>
            <span class="k">if</span> <span class="n">nfft</span><span class="p">:</span>
                <span class="n">data_ft</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nfft</span> <span class="o">=</span> <span class="n">nfft</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_ft</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c"># then add all relevant attributes</span>
            <span class="n">kwdargs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">()</span>
            <span class="n">kwdargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;is_delay&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">data_ft</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">samplerate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">samplerate</span> <span class="o">=</span> <span class="n">get_pref</span><span class="p">(</span><span class="s">&#39;DEFAULT_SAMPLERATE&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mf">44100.</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">cls</span><span class="p">,</span> <span class="n">data</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Wrong Transfer Function initialization&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_source</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">target_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">target_source</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="c"># minimum attributes</span>
        <span class="n">x</span><span class="o">.</span><span class="n">samplerate</span> <span class="o">=</span> <span class="n">samplerate</span>
        <span class="c"># flags for different types of TF</span>
        <span class="n">x</span><span class="o">.</span><span class="n">binaural</span> <span class="o">=</span> <span class="n">binaural</span>

        <span class="n">x</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">_makecoordinates</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                                <span class="n">coordinates</span><span class="p">,</span> <span class="n">binaural</span> <span class="o">=</span> <span class="n">binaural</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">target_source</span> <span class="o">=</span> <span class="n">_make_target_source</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> 
                                                     <span class="n">target_source</span><span class="p">,</span> <span class="n">binaural</span> <span class="o">=</span> <span class="n">binaural</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">x</span>
    
    <span class="c">################## internals</span>
    <span class="c"># util for new object/view creation</span>
    <span class="c"># pass whenever creating a new TransferFunction in this class</span>
    <span class="k">def</span> <span class="nf">get_kwdargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_slice</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c"># major attribute</span>
            <span class="s">&#39;samplerate&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">,</span>
            <span class="c"># binaural flag</span>
            <span class="s">&#39;binaural&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">,</span>
            <span class="c"># coordinates attributes</span>
            <span class="s">&#39;coordinates&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">,</span>
            <span class="c"># spatializer related            </span>
            <span class="s">&#39;target_source&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_source</span><span class="p">,</span> 
            <span class="p">}</span>
        <span class="k">if</span> <span class="nb">slice</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># kwdargs slicing</span>
            <span class="c"># binaural: the tf stays binaural iff all the channels are taken</span>
            <span class="k">if</span> <span class="n">_slice</span>  <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                 <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">_slice</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">test</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                     <span class="n">res</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># coordinates</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_coordinates</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">_slice</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="c"># spatializer internals</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_sources</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s">&#39;target_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_source</span><span class="p">[</span><span class="n">_slice</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="c">################### ndarray internals</span>
    <span class="c">## NDARRAY stuff</span>
    <span class="k">def</span> <span class="nf">__array_wrap__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">handled</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">__array_wrap__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#39;samplerate&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;samplerate&#39;</span><span class="p">):</span>
            <span class="n">x</span><span class="o">.</span><span class="n">samplerate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ufunc</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="c"># major attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;samplerate&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c"># binaural flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;binaural&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="c"># coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;coordinates&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c"># spatializer internals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_source</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;target_source&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        
    <span class="c">################## SLICING #######################</span>
    <span class="c"># Notes:</span>
    <span class="c"># - getitem is critical because it affects the type of IR</span>
    <span class="c"># review the slicing, it just dosn&#39;t work ok anymore</span>
    <span class="c"># always yields non binaural IR</span>
    <span class="c"># - Fancy slicing with times is disabled for now, I may need to</span>
    <span class="c"># rewrite the one in the Sound class, cause its a bit messy</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
        <span class="c"># data = np.ndarray.__getitem__(self, key)</span>
        <span class="c"># if type(key) == int and self.ndim&gt;1:</span>
        <span class="c">#     # data returns a full row of values</span>
        <span class="c">#     data.shape = (1,len(data))</span>
        <span class="c">#     kwdargs = self.get_kwdargs()</span>
        <span class="c">#     return TransferFunction(data, **kwdargs)</span>
        <span class="c"># if data.ndim == 1 and type(key) == (tuple or int):</span>
        <span class="c">#     # we have to see which dim was squeezed</span>
        <span class="c">#     # TODO</span>
        <span class="c">#     if type(key[0]) == int or type(key[0]) == np.float64:</span>
        <span class="c">#         data.shape = (1, len(data))</span>
        <span class="c">#     elif type(key[1]) == int or type(key[1]) == np.float64:</span>
        <span class="c">#         data.shape = (len(data), 1)</span>
        <span class="c"># if type(key) == tuple:</span>
        <span class="c">#     channels = key[1]</span>
        <span class="c">#     kwdargs = self.get_kwdargs(_slice = channels)</span>
        <span class="c"># else:</span>
        <span class="c">#     kwdargs = self.get_kwdargs()</span>
        <span class="c"># return TransferFunction(data, **kwdargs)</span>
    
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="c">################## binaural stuff</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">)</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">(</span><span class="n">_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">)</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">(</span><span class="n">_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>


<span class="c">################## Coordinates</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_has_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncoordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_coordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Impulse Response doesnt have coordinates&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="TransferFunction.forcoordinates"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.forcoordinates">[docs]</a>    <span class="k">def</span> <span class="nf">forcoordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Should return an impulseResponse containing all the rays headed towards source args</span>
<span class="sd">        SPEC:</span>
<span class="sd">        value peut etre un int -&gt; indexation</span>
<span class="sd">        value peut etre une rotation?</span>
<span class="sd">        value peut etre un tuple (len=2) az, el</span>
<span class="sd">        value peut etre une condition: mieux!</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># argument parsing</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c"># indexing is just the i&#39;th IR</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c"># kwdargs handling</span>
            <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">(</span><span class="n">_slice</span> <span class="o">=</span> <span class="n">i</span><span class="p">)</span>
        
            <span class="c"># data collection</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">idx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">fun</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">):</span>
                    <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="p">[:,</span> <span class="n">idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span><span class="mi">2</span><span class="p">]))</span>

            
                <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">(</span><span class="n">_slice</span> <span class="o">=</span> <span class="n">idx</span><span class="p">)</span>
                <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">return</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_debug</span><span class="p">(</span><span class="s">&#39;No HRTF found matching condition&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>
            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">azs</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">els</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">els</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
                <span class="n">azs</span> <span class="o">=</span> <span class="p">[</span><span class="n">azs</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">els</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
                <span class="n">els</span> <span class="o">=</span> <span class="p">[</span><span class="n">els</span><span class="p">]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">azim</span><span class="p">,</span> <span class="n">elev</span><span class="p">:</span> <span class="n">azim</span> <span class="ow">in</span> <span class="n">azs</span> <span class="ow">and</span> <span class="n">elev</span> <span class="ow">in</span> <span class="n">els</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcoordinates</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            
    <span class="c">#################### Spatializer features</span>
    <span class="c"># this includes:</span>
    <span class="c"># attrs:</span>
    <span class="c"># - incoming_direction,source</span>
    <span class="c"># methods:</span>
    <span class="c"># - forsource()</span>
    <span class="c"># flags for different types of TransferFunction</span>
    </div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_has_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_source</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nsources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_sources</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_source</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_debug</span><span class="p">(</span><span class="s">&#39;TransferFunction has no target_source, falling back, you should use .shape! or .ncoordinates&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<div class="viewcode-block" id="TransferFunction.forsource"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.forsource">[docs]</a>    <span class="k">def</span> <span class="nf">forsource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the part of the impulse response that is related to source k</span>
<span class="sd">        Only implemented for impulse response that are the result of computations in the spatializer</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;This method isnt implemented for this type of TF&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_source</span> <span class="o">!=</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No data for this source&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_source</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">(</span><span class="n">_slice</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_source</span><span class="p">)</span>

<div class="viewcode-block" id="TransferFunction.collapse"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.collapse">[docs]</a>    <span class="k">def</span> <span class="nf">collapse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        An TransferFunction that is the result from Spatializer computations has sources attached to it and possibly multiple rays per source.</span>
<span class="sd">        Using collapse on it yields a new TransferFunction with only one TransferFunction per source.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">zerosTF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                      <span class="n">target_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">binaural</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">):</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forsource</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="c">#chunki = onesTF</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">left</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">print</span> <span class="s">&#39;why?&#39;</span>
            <span class="n">res</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[:,</span> <span class="n">k</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nsources</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="c">################### DSP Features</span>
    <span class="c"># -listening of TFs</span>
    <span class="c"># -applying to sounds</span></div>
<div class="viewcode-block" id="TransferFunction.listen"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.listen">[docs]</a>    <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sound</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">sleep</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">reference</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If impulse response is more than one binaural or monaural,</span>
<span class="sd">        then all the sounds are played in a sequence</span>
<span class="sd">        </span>
<span class="sd">        TDO: WRITE DOC</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">sound</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">soundfile</span> <span class="o">=</span> <span class="n">get_pref</span><span class="p">(</span><span class="s">&#39;DEFAULT_SOUND&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">soundfile</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">sound</span> <span class="o">=</span> <span class="n">Sound</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">soundfile</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sound</span> <span class="o">=</span> <span class="n">pinknoise</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">samplerate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">sound</span> <span class="o">=</span> <span class="n">Sound</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reference</span><span class="p">:</span>
            <span class="n">log_debug</span><span class="p">(</span><span class="s">&#39;Listening to original sound&#39;</span><span class="p">)</span>
            <span class="n">sound</span><span class="o">.</span><span class="n">atlevel</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">sleep</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_coordinates</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncoordinates</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcoordinates</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
                <span class="n">log_debug</span><span class="p">(</span><span class="s">&#39;Listening to TF for coordinates &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">out</span><span class="o">.</span><span class="n">atlevel</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">sleep</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
            <span class="n">log_debug</span><span class="p">(</span><span class="s">&#39;Listening to TF&#39;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">atlevel</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">sleep</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TransferFunction.apply"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">outlevel</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Applies the current Impulse responses to a sound.</span>
<span class="sd">        Either yields a single sound in the case where the Impulse response is only relative to a single source. Otherwise outputs a list of sounds for each source.</span>
<span class="sd">        </span>
<span class="sd">        Gain normalisation (outlevel kwdarg): by default the gain is adjusted to that the loudest channel is at the level specified by outlevel. Hence the difference in level between the two channels is preserved. This is a different behavior from the one in brian.hears.sounds        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ir</span> <span class="o">=</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ir</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">outlevel</span> <span class="o">=</span> <span class="n">outlevel</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="o">.</span><span class="mi">54</span><span class="p">,</span> <span class="n">octavefraction</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nchannels</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,</span><span class="n">channel</span><span class="p">]</span>
            <span class="n">amps</span> <span class="o">=</span> <span class="n">nonuniform_spectralsmoothing</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">octavefraction</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">)</span>
            <span class="n">phasepart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">res</span><span class="p">[:,</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">amps</span><span class="o">*</span><span class="n">phasepart</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    
<span class="c">######################### Plotting</span>
<div class="viewcode-block" id="TransferFunction.plot"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dB</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">display</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plots the spectrum of the TF</span>
<span class="sd">        TODO: whould simply call TF().plot()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">dBconv</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dB</span><span class="p">:</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
        <span class="n">semilogx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="n">offset</span><span class="p">:],</span> <span class="n">conv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amplitudes</span><span class="p">[</span><span class="n">offset</span><span class="p">:,:]),</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
            <span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Amplitude (dB)&#39;</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">axis</span><span class="p">())</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
            <span class="n">axis</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Amplitude (gain)&#39;</span><span class="p">)</span>
            <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
        <span class="n">semilogx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="n">offset</span><span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="n">offset</span><span class="p">:,:]),</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Phase (rad)&#39;</span><span class="p">)</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
        <span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">legend</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">show</span><span class="p">()</span>
    
</div>
<div class="viewcode-block" id="TransferFunction.ild"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.ild">[docs]</a>    <span class="k">def</span> <span class="nf">ild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the interaural level difference in dB</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dBconv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dBconv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">[</span><span class="n">indices</span><span class="p">,:]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">[</span><span class="n">indices</span><span class="p">,:])</span>

</div>
<div class="viewcode-block" id="TransferFunction.itd"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.itd">[docs]</a>    <span class="k">def</span> <span class="nf">itd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the interaural phase delay in ms</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="mf">1e3</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curfreqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="mf">1e3</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">[</span><span class="n">indices</span><span class="p">,:]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">[</span><span class="n">indices</span><span class="p">,:]),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">curfreqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">curfreqs</span><span class="p">),</span> <span class="mi">1</span><span class="p">)))))</span>

</div>
<div class="viewcode-block" id="TransferFunction.igd"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.igd">[docs]</a>    <span class="k">def</span> <span class="nf">igd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the interaural group delay in ms,</span>
<span class="sd">        only for positive frequencies by default (because of the diff)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">curfreqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">deltafs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">curfreqs</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="mf">1e3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ipd</span><span class="p">(</span><span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">deltafs</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">tmp</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</div>
<div class="viewcode-block" id="TransferFunction.idi"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.idi">[docs]</a>    <span class="k">def</span> <span class="nf">idi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the interaural diffraction index in radians</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">curfreqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">curfreqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">curfreqs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

        <span class="n">tmp</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">curfreqs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itd</span><span class="p">(</span><span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">igd</span><span class="p">(</span><span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">1000.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        
        <span class="k">return</span> <span class="n">tmp</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</div>
<div class="viewcode-block" id="TransferFunction.ipd"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.ipd">[docs]</a>    <span class="k">def</span> <span class="nf">ipd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the interaural phase difference in radians</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curfreqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">[</span><span class="n">indices</span><span class="p">,:]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">[</span><span class="n">indices</span><span class="p">,:])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</div>
<div class="viewcode-block" id="TransferFunction.plot_binaural_cues"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.plot_binaural_cues">[docs]</a>    <span class="k">def</span> <span class="nf">plot_binaural_cues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frange</span> <span class="o">=</span> <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">20000</span><span class="p">),</span> <span class="n">display</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">smoothing</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plots the binaural cues</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaural</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Cannot plot binaural cues of non-binaural TF&#39;</span><span class="p">)</span>
        <span class="n">posfreqs_idx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">&gt;</span> <span class="n">frange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="o">&lt;</span><span class="n">frange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">posfreqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="n">posfreqs_idx</span><span class="p">]</span>
        
        <span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
        <span class="n">ilds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ild</span><span class="p">(</span><span class="n">indices</span> <span class="o">=</span> <span class="n">posfreqs_idx</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">gca</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">ilds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">kpos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ilds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">smoothing</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">posfreqs</span><span class="p">,</span> <span class="n">octaveband_smoothing</span><span class="p">(</span><span class="n">ilds</span><span class="p">[:,</span><span class="n">kpos</span><span class="p">],</span> <span class="n">smoothing</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="n">kpos</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">posfreqs</span><span class="p">,</span> <span class="n">ilds</span><span class="p">[:,</span><span class="n">kpos</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="n">kpos</span><span class="p">]))</span>

        <span class="c"># for kposition in xrange(self.ncoordinates):</span>
        <span class="c">#     print ilds[1, kposition]</span>
        <span class="c">#     annotate(&#39;%.1f&#39; % (self.coordinates[&#39;azim&#39;][kposition]),</span>
        <span class="c">#              xy = (0, ilds[1, kposition]))</span>
            
        <span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
        <span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;ILD (dB)&#39;</span><span class="p">)</span>

        <span class="n">xlim</span><span class="p">(</span><span class="n">posfreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posfreqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
        <span class="n">itds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span><span class="p">(</span><span class="n">indices</span> <span class="o">=</span> <span class="n">posfreqs_idx</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">gca</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">kpos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ilds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">smoothing</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">posfreqs</span><span class="p">,</span> <span class="n">octaveband_smoothing</span><span class="p">(</span><span class="n">itds</span><span class="p">[:,</span><span class="n">kpos</span><span class="p">],</span> <span class="n">smoothing</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="n">kpos</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">posfreqs</span><span class="p">,</span> <span class="n">itds</span><span class="p">[:,</span><span class="n">kpos</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="n">kpos</span><span class="p">]))</span>

        <span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Frequency (Hz)&#39;</span><span class="p">)</span>
        <span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;ITD (ms)&#39;</span><span class="p">)</span>
        <span class="n">xlim</span><span class="p">(</span><span class="n">posfreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">posfreqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">show</span><span class="p">()</span>
        </div>
    <span class="k">def</span> <span class="nf">convolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">ir</span> <span class="o">=</span> <span class="n">ImpulseResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ir</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="c"># ndarray stuff</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwdargs</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="c">##### TODO : check why repr and str don&#39;t work without this</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">)</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">)</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()</span>

    <span class="c"># global properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nchannels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nfft</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">freqs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfft</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fbin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nfft</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">amplitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c"># load/save</span>
<div class="viewcode-block" id="TransferFunction.save"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Uses pickle.dump on ``filename`` to dump the current ir.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TransferFunction.load"><a class="viewcode-back" href="../../../user/signal.html#pynaural.signal.impulseresponse.TransferFunction.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Uses pickle.load on ``filename`` to load a pickled ir.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>
    
    <span class="c"># constructors</span></div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">zerosTF</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">_shape_from_kwdargs</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">kwdargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">delayTF</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">delayIR</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">))</span>
    
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">onesTF</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">_shape_from_kwdargs</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">kwdargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">binauralTF</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">TransferFunction</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

<span class="c">######## Yes do that</span></div>
<span class="n">zerosTF</span> <span class="o">=</span> <span class="n">TransferFunction</span><span class="o">.</span><span class="n">zerosTF</span>        
<span class="n">onesTF</span> <span class="o">=</span> <span class="n">TransferFunction</span><span class="o">.</span><span class="n">onesTF</span>
<span class="n">delayTF</span> <span class="o">=</span> <span class="n">TransferFunction</span><span class="o">.</span><span class="n">delayTF</span>        
<span class="n">binauralTF</span> <span class="o">=</span> <span class="n">TransferFunction</span><span class="o">.</span><span class="n">binauralTF</span>

<span class="c">######################################## UTILS</span>

<span class="k">def</span> <span class="nf">dur2sample</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">samplerate</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">duration</span><span class="o">*</span><span class="n">samplerate</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">sample2dur</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">samplerate</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">samplerate</span>

<span class="k">def</span> <span class="nf">getnsample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">samplerate</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dur2sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">samplerate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
        

<span class="c">########### coordinates, target_source</span>
<span class="k">def</span> <span class="nf">_makecoordinates</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">binaural</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="c"># utility to construct the coordinate array</span>
    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">dtype_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;azim&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;elev&#39;</span><span class="p">,</span><span class="s">&#39;f8&#39;</span><span class="p">)]</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coords</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype_coords</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">binaural</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">==</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype_coords</span><span class="p">)</span>
        <span class="n">coordinates</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="n">coordinates</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">=</span> <span class="n">coords</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype_coords</span><span class="p">)</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype_coords</span><span class="p">)</span>
            <span class="n">coordinates</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>


    <span class="k">if</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">binaural</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Couldnt retrieve the right number of coordinates &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; vs. &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
<span class="c">#            if (coordinates[:n] != coordinates[n:]).all():</span>
<span class="c">#                raise ValueError(&#39;Couldnt retrieve the right number of coordinates, coordinates not repeated!&#39;)</span>
    <span class="k">return</span> <span class="n">coordinates</span>

<span class="k">def</span> <span class="nf">_make_target_source</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">binaural</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">binaural</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">==</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">target_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
        <span class="n">target_source</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="n">target_source</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">target_source</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>

    <span class="k">if</span> <span class="n">target_source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">binaural</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;got &#39;</span><span class="p">,</span> <span class="n">target_source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">print</span> <span class="s">&#39;expected&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Couldnt retrieve the right number of target_source&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
<span class="c">#            if (target_source[:n] != target_source[n:]).all():</span>
<span class="c">#                raise ValueError(&#39;Couldnt retrieve the right Number Of target_source, target_source not repeated!&#39;)</span>

    <span class="k">return</span> <span class="n">target_source</span>

<span class="k">def</span> <span class="nf">_shape_from_kwdargs</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">kwdargs</span><span class="p">):</span>
    <span class="c"># this is used for the initialization through staticmethods.</span>
    <span class="c"># it guesses the shape out of the provided shape (which might be a</span>
    <span class="c"># single Quantity)</span>
    <span class="c">#</span>
    <span class="c">###### dimension 0</span>
    <span class="n">samplerate</span> <span class="o">=</span> <span class="n">kwdargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;samplerate&#39;</span><span class="p">,</span> <span class="n">get_pref</span><span class="p">(</span><span class="s">&#39;DEFAULT_SAMPLERATE&#39;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">samplerate</span><span class="p">)</span>
    
    <span class="c">###### dimension 1</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;coordinates&#39;</span> <span class="ow">in</span> <span class="n">kwdargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;coordinates&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s">&#39;target_source&#39;</span> <span class="ow">in</span> <span class="n">kwdargs</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;target_source&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s">&#39;binaural&#39;</span> <span class="ow">in</span> <span class="n">kwdargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwdargs</span><span class="p">[</span><span class="s">&#39;binaural&#39;</span><span class="p">]:</span>
            <span class="n">n</span> <span class="o">*=</span> <span class="mi">2</span>
    <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shape</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">delayIR</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/index.html">User Guide</a></li>
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="../../../search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../../genindex.html" title="General Index"
             >index</a>
        </div>

        <div class="right">
          
    <div class="footer">
        &copy; Copyright 2013, Victor Benichoux.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>